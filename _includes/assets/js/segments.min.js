// (c) 2015 <https://github.com/onei>
// foo

(function($){'use strict';var disabled=false,x={offset:null,start:null,first:null,last:null},settings={activeLow:1,order:1,colour:'green'},maxElements=4,init={main:function(){init.setDimensions();init.setupSegments();init.setColour();init.checkSettings();$('#segRail .seg').click(segments.highlight);$('#chevronLeft').click(segments.moveLeft);$('#chevronRight').click(segments.moveRight);$('#optionsColours .pick').click(options.colourPick);$('#inputsLetters .letter').click(inputs.highlightLetter);$('#configForm input').click(init.checkSettings);},setDimensions:function(){var maxWidth=$('#article').width(),overlayWidth=$('#segOverlayLeft').width(),segmentWidth=$('#segRail .seg-display').width(),separatorWidth=(maxWidth-(2*overlayWidth)-(segmentWidth*4))/3;x.offset=segmentWidth+separatorWidth;x.start=overlayWidth;console.log('xstart, xOffset:',x.start,x.offset);},setupSegments:function(){var $segs=$('#segRail .seg-display');$segs.each(function(index){var $this=$(this),viewIndex=index-2,xPosition=x.start+(viewIndex*x.offset),css='translateX('+xPosition+'px)';$this.css('transform',css);if(viewIndex>=0&&viewIndex<4){$this.attr('data-view',viewIndex);}
if(index===0){x.first=xPosition;}else if(index===7){x.last=xPosition;}});},setColour:function(){var ucColour=settings.colour.charAt(0).toUpperCase()+settings.colour.slice(1);$('#coloursPick'+ucColour).addClass('selected');$('#segRail, #inputsLetters, #inputsHex, #inputsBinary, #inputsHexCombined').addClass(settings.colour);console.log($('#segRail, #inputsLetters, #inputsHex, #inputsBinary, #inputsHexCombined').get());},checkSettings:function(){settings.oldOrder=settings.order;settings.activeLow=$('#configActive input[name="active"]:checked').val()*1;settings.order=$('#configOrder input[name="order"]:checked').val()*1;console.log(settings);init.enforceSettings();},enforceSettings:function(){var $letters=$('#inputsLetters .view');if(settings.order!==settings.oldOrder){$letters.each(function(){var $this=$(this),$letters=$this.children();$this.append($letters.get().reverse());});}
inputs.updateBinaryHex();}},segments={moveLeft:function(){if(disabled){return;}
disabled=true;setTimeout(function(){disabled=false;},550);var $segs=$('#segRail .seg-display'),re=/matrix\(\s*-?\d+,\s*-?\d+,\s*-?\d+,\s*-?\d+,\s*(-?\d+),\s*(-?\d+)\s*\)/,viewFirst;$segs.each(function(){var $this=$(this),transform=$this.css('transform'),matches=transform.match(re),xPosition,css;if(matches===null){return;}
xPosition=matches[1]*1;xPosition-=x.offset;css='translateX('+xPosition+'px)';$this.css('transform',css);});viewFirst=$segs.filter('[data-view="0"]').attr('data-index');viewFirst=(viewFirst*1)+1;segments.reView(viewFirst);segments.append();inputs.rebuildHighlights(viewFirst);},moveRight:function(){if(disabled){return;}
disabled=true;setTimeout(function(){disabled=false;},550);var $segs=$('#segRail .seg-display'),re=/matrix\(\s*-?\d+,\s*-?\d+,\s*-?\d+,\s*-?\d+,\s*(-?\d+),\s*(-?\d+)\s*\)/,viewFirst;$segs.each(function(){var $this=$(this),transform=$this.css('transform'),matches=transform.match(re),xPosition,css;if(matches===null){return;}
xPosition=matches[1]*1;xPosition+=x.offset;css='translateX('+xPosition+'px)';$this.css('transform',css);});viewFirst=$segs.filter('[data-view="0"]').attr('data-index');viewFirst=(viewFirst*1)-1;segments.reView(viewFirst);segments.prepend();if($segs.length<$('#segRail .seg-display').length){viewFirst+=1}
inputs.rebuildHighlights(viewFirst);},append:function(){var $rail=$('#segRail'),$segs=$rail.find('.seg-display'),$lastViewSeg=$segs.filter('[data-view="3"]'),index=$lastViewSeg.attr('data-index')*1,$clone,css;if(index+2>=$segs.length){$clone=$lastViewSeg.clone(true);css='translateX('+x.last+'px)';$clone.css('transform',css);$clone.removeAttr('data-view');$rail.append($clone);segments.reIndex();}},prepend:function(){var $rail=$('#segRail'),$firstViewSeg=$rail.find('.seg-display[data-view="0"]'),index=$firstViewSeg.attr('data-index')*1,$clone,css;if(index-2<0){$clone=$firstViewSeg.clone(true);css='translateX('+x.first+'px)';$clone.css('transform',css);$clone.removeAttr('data-view');$rail.prepend($clone);segments.reIndex();}},reIndex:function(){var $segs=$('#segRail .seg-display');$segs.removeAttr('data-index');$segs.each(function(index){$(this).attr('data-index',index);});},reView:function(index){var $segs=$('#segRail .seg-display'),$oldView,i;$segs.removeAttr('data-view');$segs.slice(index,index+4).each(function(i){$(this).attr('data-view',i);});},highlight:function(){var $this=$(this),$view=$this.parents('.seg-display'),letter=$this.attr('data-segment'),viewIndex=$view.attr('data-view'),$letter=$('#inputsLetters .view').filter('[data-view="'+viewIndex+'"]').find('.letter').filter('[data-letter="'+letter+'"]');if(svg.hasClass($this,'on')){svg.removeClass($this,'on');$letter.removeClass('on');}else{svg.addClass($this,'on');$letter.addClass('on');}
inputs.updateBinaryHex();}},options={colourPick:function(){var $this=$(this),$old=$('#optionsColours .selected'),$update=$('#segRail, #inputsLetters, #inputsHex, #inputsBinary, #inputsHexCombined'),newClass=$this.attr('data-colour'),oldClass=$old.attr('data-colour');$old.removeClass('selected');$this.addClass('selected');$update.removeClass(oldClass).addClass(newClass);}},inputs={highlightLetter:function(){var $this=$(this),$view=$this.parent('.view'),letter=$this.attr('data-letter'),viewIndex=$view.attr('data-view'),$segment=$('#segRail .seg-display').filter('[data-view="'+viewIndex+'"]').find('.seg').filter('[data-segment="'+letter+'"]');if($this.hasClass('on')){$this.removeClass('on');svg.removeClass($segment,'on');}else{$this.addClass('on');svg.addClass($segment,'on');}
inputs.updateBinaryHex();},rebuildHighlights:function(index){var ids=['DP','G','F','E','D','C','B','A'],$letters=$('#inputsLetters .view'),$segs=$('#segRail .seg-display').slice(index,index+4);$segs.each(function(i){var $seg=$(this),$letter=$letters.eq(i).find('.letter');$letter.removeClass('on');ids.forEach(function(id){var $path=$seg.find('[data-segment="'+id+'"]');if(svg.hasClass($path,'on')){$letter.filter('[data-letter="'+id+'"]').addClass('on');}});});inputs.updateBinaryHex();},updateBinaryHex:function(){var $letters=$('#inputsLetters .view'),$bins=$('#inputsBinary .view'),$hexs=$('#inputsHex .view'),hexCombined='0x',k=0,mixClasses=['mix-0','mix-1','mix-2','mix-3','mix-4','mix-5','mix-6','mix-7','mix-8'],mixPrefix='mix-';mixClasses=mixClasses.join(' ');$letters.each(function(i){var $this=$(this),$bin=$bins.eq(i),$hex=$hexs.eq(i),j=0,binStr='0b',hexStr='0x';$this.find('.letter').each(function(){if($(this).hasClass('on')){binStr+=((settings.activeLow===1)?'0':'1');j+=1;}else{binStr+=((settings.activeLow===1)?'1':'0');}});hexStr+=('00'+(binStr*1).toString(16)).slice(-2);$bin.text(binStr);$hex.text(hexStr);$bin.removeClass(mixClasses).addClass(mixPrefix+j).text(binStr);$hex.removeClass(mixClasses).addClass(mixPrefix+j).text(hexStr);hexCombined+=hexStr.slice(-2);k+=j;});k=Math.floor(k/maxElements);console.log(k);$('#inputsHexCombined .combined').removeClass(mixClasses).addClass(mixPrefix+k).text(hexCombined);}},svg={addClass:function($elem,toAdd){if(svg.hasClass($elem,toAdd)){return;}
var classes=$elem.attr('class');classes+=' '+toAdd;$elem.attr('class',classes);},removeClass:function($elem,toRemove){toRemove=toRemove.trim();var classes=$elem.attr('class').split(/\s/),index=classes.indexOf(toRemove);if(index>-1){classes.splice(index,1);classes=classes.join(' ');$elem.attr('class',classes);}},hasClass:function($elem,toCheck){var classes=$elem.attr('class');classes=' '+classes+' ';toCheck=' '+toCheck+' ';if(classes.indexOf(toCheck)>-1){return true;}
return false;}};$(init.main);}(jQuery));